/* Edge Detection NPP - Sobel edge detection using NPP
 * Based on boxFilterNPP by NVIDIA CORPORATION
 * Modified to perform Sobel edge detection for edge finding
 */

#if defined(WIN32) || defined(_WIN32) || defined(WIN64) || defined(_WIN64)
#define WINDOWS_LEAN_AND_MEAN
#define NOMINMAX
#include <windows.h>
#pragma warning(disable : 4819)
#endif

#include <Exceptions.h>
#include <ImageIO.h>
#include <ImagesCPU.h>
#include <ImagesNPP.h>

#include <string.h>
#include <fstream>
#include <iostream>

#include <cuda_runtime.h>
#include <npp.h>

#include <helper_cuda.h>
#include <helper_string.h>

bool printfNPPinfo(int argc, char *argv[])
{
  const NppLibraryVersion *libVer = nppGetLibVersion();

  printf("NPP Library Version %d.%d.%d\n", libVer->major, libVer->minor,
         libVer->build);

  int driverVersion, runtimeVersion;
  cudaDriverGetVersion(&driverVersion);
  cudaRuntimeGetVersion(&runtimeVersion);

  printf("  CUDA Driver  Version: %d.%d\n", driverVersion / 1000,
         (driverVersion % 100) / 10);
  printf("  CUDA Runtime Version: %d.%d\n", runtimeVersion / 1000,
         (runtimeVersion % 100) / 10);

  bool bVal = checkCudaCapabilities(1, 0);
  return bVal;
}

int main(int argc, char *argv[])
{
  printf("%s Starting...\n\n", argv[0]);

  try
  {
    std::string sFilename;
    char *filePath;

    findCudaDevice(argc, (const char **)argv);

    if (printfNPPinfo(argc, argv) == false)
    {
      exit(EXIT_SUCCESS);
    }

    if (checkCmdLineFlag(argc, (const char **)argv, "input"))
    {
      getCmdLineArgumentString(argc, (const char **)argv, "input", &filePath);
    }
    else
    {
      filePath = sdkFindFilePath("Lena.pgm", argv[0]);
    }

    if (filePath)
    {
      sFilename = filePath;
    }
    else
    {
      sFilename = "Lena.pgm";
    }

    // Check if file exists
    int file_errors = 0;
    std::ifstream infile(sFilename.data(), std::ifstream::in);

    if (infile.good())
    {
      std::cout << "edgeDetectionNPP opened: <" << sFilename.data()
                << "> successfully!" << std::endl;
      file_errors = 0;
      infile.close();
    }
    else
    {
      std::cout << "edgeDetectionNPP unable to open: <" << sFilename.data() << ">"
                << std::endl;
      file_errors++;
      infile.close();
    }

    if (file_errors > 0)
    {
      exit(EXIT_FAILURE);
    }

    // Load grayscale image
    npp::ImageCPU_8u_C1 oHostSrc;
    npp::loadImage(sFilename, oHostSrc);
    npp::ImageNPP_8u_C1 oDeviceSrc(oHostSrc);

    NppiSize oSrcSize = {(int)oDeviceSrc.width(), (int)oDeviceSrc.height()};
    NppiPoint oSrcOffset = {0, 0};
    NppiSize oSizeROI = {(int)oDeviceSrc.width(), (int)oDeviceSrc.height()};

    // Allocate device images for horizontal and vertical Sobel
    npp::ImageNPP_8u_C1 oDeviceDstH(oSizeROI.width, oSizeROI.height);
    npp::ImageNPP_8u_C1 oDeviceDstV(oSizeROI.width, oSizeROI.height);
    
    std::cout << "\nApplying Sobel edge detection..." << std::endl;

    // Apply Sobel horizontal edge detection
    std::cout << "  Computing horizontal edges..." << std::endl;
    NPP_CHECK_NPP(nppiFilterSobelHorizBorder_8u_C1R(
        oDeviceSrc.data(), oDeviceSrc.pitch(), oSrcSize, oSrcOffset,
        oDeviceDstH.data(), oDeviceDstH.pitch(), oSizeROI,
        NPP_BORDER_REPLICATE));

    // Apply Sobel vertical edge detection
    std::cout << "  Computing vertical edges..." << std::endl;
    NPP_CHECK_NPP(nppiFilterSobelVertBorder_8u_C1R(
        oDeviceSrc.data(), oDeviceSrc.pitch(), oSrcSize, oSrcOffset,
        oDeviceDstV.data(), oDeviceDstV.pitch(), oSizeROI,
        NPP_BORDER_REPLICATE));

    // Save horizontal edges
    npp::ImageCPU_8u_C1 oHostDstH(oDeviceDstH.size());
    oDeviceDstH.copyTo(oHostDstH.data(), oHostDstH.pitch());
    
    std::string sResultFilenameH = sFilename;
    std::string::size_type dot = sResultFilenameH.rfind('.');
    if (dot != std::string::npos)
    {
      sResultFilenameH = sResultFilenameH.substr(0, dot);
    }
    sResultFilenameH += "_edges_horizontal.pgm";
    saveImage(sResultFilenameH, oHostDstH);
    std::cout << "Saved horizontal edges: " << sResultFilenameH << std::endl;

    // Save vertical edges
    npp::ImageCPU_8u_C1 oHostDstV(oDeviceDstV.size());
    oDeviceDstV.copyTo(oHostDstV.data(), oHostDstV.pitch());
    
    std::string sResultFilenameV = sFilename;
    dot = sResultFilenameV.rfind('.');
    if (dot != std::string::npos)
    {
      sResultFilenameV = sResultFilenameV.substr(0, dot);
    }
    sResultFilenameV += "_edges_vertical.pgm";
    saveImage(sResultFilenameV, oHostDstV);
    std::cout << "Saved vertical edges: " << sResultFilenameV << std::endl;

    std::cout << "\nEdge detection complete!" << std::endl;
    std::cout << "Horizontal edges show left-right transitions." << std::endl;
    std::cout << "Vertical edges show up-down transitions." << std::endl;

    // Free device memory
    nppiFree(oDeviceSrc.data());
    nppiFree(oDeviceDstH.data());
    nppiFree(oDeviceDstV.data());

    exit(EXIT_SUCCESS);
  }
  catch (npp::Exception &rException)
  {
    std::cerr << "Program error! The following exception occurred: \n";
    std::cerr << rException << std::endl;
    std::cerr << "Aborting." << std::endl;

    exit(EXIT_FAILURE);
  }
  catch (...)
  {
    std::cerr << "Program error! An unknown type of exception occurred. \n";
    std::cerr << "Aborting." << std::endl;

    exit(EXIT_FAILURE);
    return -1;
  }

  return 0;
}
